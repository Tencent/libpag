name: build

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:

  android:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Repo
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Get Third-Party Cache
        id: third-party-cache
        uses: actions/cache/restore@v3
        with:
          path: |
            third_party
            tgfx
          key: third-party-android-${{ hashFiles('DEPS') }}-${{ hashFiles('vendor.json') }}-${{ hashFiles('test/baseline/version.json') }}
          restore-keys: third-party-android-

      - uses: seanmiddleditch/gha-setup-ninja@master

      - name: Run depsync
        run: |
          npm install depsync -g
          depsync
        shell: bash

      - uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r19c
          local-cache: true

      - name: Build Android
        run: |
          node build_pag -p android -a arm64
        env:
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Save Third-Party Cache
        if: ${{ (github.event_name == 'push') && (steps.third-party-cache.outputs.cache-hit != 'true') }}
        uses: actions/cache/save@v3
        with:
          path: |
            third_party
            tgfx
          key: third-party-android-${{ hashFiles('DEPS') }}-${{ hashFiles('vendor.json') }}-${{ hashFiles('test/baseline/version.json') }}

      - name: Job Failed
        if: ${{ failure() }}
        uses: actions/upload-artifact@v3
        with:
          name: libpag_android_arm64v8a
          path: out

      - uses: actions/upload-artifact@v3
        with:
          name: libpag_android_arm64v8a
          path: out
